---
##
##
### NETBOX_LOOKUP
##
##
- name: "NETBOX_LOOKUP 1: Lookup returns exactly two sites"
  assert:
    that: "{{ query_result|count }} == 3"
  vars:
    query_result: "{{ query('netbox.netbox.nb_lookup', 'sites', api_endpoint='http://localhost:32768', token='0123456789abcdef0123456789abcdef01234567') }}"

- name: "NETBOX_LOOKUP 2: Query doesn't return Wibble (sanity check json_query)"
  assert:
    that: "{{ query_result|json_query('[?value.display_name==`Wibble`]')|count }} == 0"
  vars:
    query_result: "{{ query('netbox.netbox.nb_lookup', 'devices', api_endpoint='http://localhost:32768', token='0123456789abcdef0123456789abcdef01234567') }}"

- name: "NETBOX_LOOKUP 3: Device query returns exactly one TestDeviceR1"
  assert:
    that: "{{ query_result|json_query('[?value.display_name==`TestDeviceR1`]')|count }} == 1"
  vars:
    query_result: "{{ query('netbox.netbox.nb_lookup', 'devices', api_endpoint='http://localhost:32768', token='0123456789abcdef0123456789abcdef01234567') }}"

- name: "NETBOX_LOOKUP 4: VLAN ID 400 can be queried and is named 'Test VLAN'"
  assert:
    that: "{{ (query_result|json_query('[?value.vid==`400`].value.name'))[0] == 'Test VLAN' }}"
  vars:
    query_result: "{{ query('netbox.netbox.nb_lookup', 'vlans', api_endpoint='http://localhost:32768', token='0123456789abcdef0123456789abcdef01234567') }}"

- name: "NETBOX_LOOKUP 5: Add one of two devices for lookup filter test."
  netbox.netbox.netbox_device:
    netbox_url: "http://localhost:32768"
    netbox_token: "0123456789abcdef0123456789abcdef01234567"
    data:
      name: "L1"
      device_type: "Cisco Test"
      device_role: "Core Switch"
      site: "Test Site"
      status: "Staged"
      tags:
        - "nolookup"
    state: present

- name: "NETBOX_LOOKUP 6: Add two of two devices for lookup filter test."
  netbox.netbox.netbox_device:
    netbox_url: "http://localhost:32768"
    netbox_token: "0123456789abcdef0123456789abcdef01234567"
    data:
      name: "L2"
      device_type: "Cisco Test"
      device_role: "Core Switch"
      site: "Test Site2"
      status: "Staged"
      tags:
        - "lookup"
    state: present

- name: "NETBOX_LOOKUP 7: Device query returns exactly the L2 device"
  assert:
    that: "{{ query_result|json_query('[?value.display_name==`L2`]')|count }} == 1"
  vars:
    query_result: "{{ query('netbox.netbox.nb_lookup', 'devices', api_filter='role=core-switch tag=lookup', api_endpoint='http://localhost:32768', token='0123456789abcdef0123456789abcdef01234567') }}"

- name: "NETBOX_LOOKUP 8: Device query specifying raw data returns payload without key/value dict"
  assert:
    that: "{{ query_result|json_query('[?display_name==`L2`]')|count }} == 1"
  vars:
    query_result: "{{ query('netbox.netbox.nb_lookup', 'devices', api_filter='role=core-switch tag=lookup', api_endpoint='http://localhost:32768', token='0123456789abcdef0123456789abcdef01234567', raw_data=True) }}"

- name: "NETBOX_LOOKUP 9: Device query specifying multiple sites, Make sure L1 and L2 are in the results"
  assert:
    that:
      - "'L1' in {{ query_result |json_query('[*].display_name') }}"
      - "'L2' in {{ query_result |json_query('[*].display_name') }}"
  vars:
    query_result: "{{ query('netbox.netbox.nb_lookup', 'devices', api_filter='role=core-switch site=test-site site=test-site2', api_endpoint='http://localhost:32768', token='0123456789abcdef0123456789abcdef01234567', raw_data=True) }}"

- name: "NETBOX_LOOKUP 10: Device query by ID"
  assert:
    that:
      - "{{ query('netbox.netbox.nb_lookup', 'devices', api_filter='id=1', api_endpoint='http://localhost:32768', token='0123456789abcdef0123456789abcdef01234567') }}"
